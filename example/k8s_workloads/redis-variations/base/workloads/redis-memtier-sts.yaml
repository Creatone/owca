apiVersion: v1
kind: Service
metadata:
  name: redis
spec:
  clusterIP: None
  selector:
    app: redis
---
apiVersion: apps/v1
kind: StatefulSet

metadata:
  name: memtier
  labels:
    app: memtier

spec:
  serviceName: redis
  selector:
    matchLabels:
      app: memtier
  podManagementPolicy: Parallel
  template:
    metadata:
      labels:
        app: memtier
    spec:
      containers:
        - name: memtire
          image: 100.64.176.12:80/wca/memtier_benchmark:e12ffdeaeaa12f8d9470bde0ed78b2a78cf855bc
          command:
            - bash
            - -c
            - "export identifier=${podname#memtier-}; export service=${identifier%-[+[:digit:]]};
            taskset -c $memtire_cpus memtier_benchmark --run-count=1 --json-out-file=/tmp/memtier_benchmark --server=redis-${identifier}.redis-${service} --threads=$threads --clients=$clients --pipeline=$pipeline --data-size=$datasize --random-data --hide-histogram --requests=allkeys --key-maximum=$keymaximum --ratio 1:0
            &&
            taskset -c $memtire_cpus memtier_benchmark_wrapper.pex \
            --command '\"while true; do memtier_benchmark --run-count=1 --test-time=10 --json-out-file=/tmp/memtier_benchmark --server=redis-${identifier}.redis-${service} --threads=$threads --clients=$clients --pipeline=$pipeline --data-size=$datasize --random-data --hide-histogram --requests=allkeys --key-maximum=$keymaximum --ratio $ratio $memtire_extra && sleep 1.2; done\"' \
            --log_level DEBUG \
            --stderr 0 \
            --labels '{\"workload\": \"redis\"}' \
            --metric_name_prefix 'redis_' \
            --subprocess_shell
            --storage_output_filename=/var/log/wrapper/metrics.prom
            "
          env:
            - name: podname
              valueFrom: {fieldRef: {fieldPath: metadata.name}}
            - name: threads
              valueFrom: {configMapKeyRef: { name: redis-config, key: threads }}
            - name: clients
              valueFrom: {configMapKeyRef: { name: redis-config, key: clients }}
            - name: pipeline
              valueFrom: {configMapKeyRef: { name: redis-config, key: pipeline }}
            - name: datasize
              valueFrom: {configMapKeyRef: { name: redis-config, key: datasize }}
            - name: keymaximum
              valueFrom: {configMapKeyRef: { name: redis-config, key: keymaximum }}
            - name: ratio
              valueFrom: {configMapKeyRef: { name: redis-config, key: ratio }}
            - name: memtire_cpus
              valueFrom: {configMapKeyRef: { name: redis-config, key: memtire_cpus }}
            - name: memtire_extra
              valueFrom: {configMapKeyRef: { name: redis-config, key: memtire_extra }}
          volumeMounts:
            - name: var-log-wrapper
              mountPath: /var/log/wrapper

        - name: node-exporter
          image: prom/node-exporter:v0.18.1
          securityContext:
            privileged: true
          args:
            - --collector.textfile.directory=/var/log/wrapper
            - --web.disable-exporter-metrics
            - --no-collector.arp
            - --no-collector.bcache
            - --no-collector.bonding
            - --no-collector.conntrack
            - --no-collector.cpu
            - --no-collector.cpufreq
            - --no-collector.diskstats
            - --no-collector.edac
            - --no-collector.entropy
            - --no-collector.filefd
            - --no-collector.filesystem
            - --no-collector.hwmon
            - --no-collector.infiniband
            - --no-collector.ipvs
            - --no-collector.loadavg
            - --no-collector.mdadm
            - --no-collector.meminfo
            - --no-collector.netclass
            - --no-collector.netdev
            - --no-collector.netstat
            - --no-collector.nfs
            - --no-collector.nfsd
            - --no-collector.pressure
            - --no-collector.sockstat
            - --no-collector.stat
            - --no-collector.time
            - --no-collector.timex
            - --no-collector.uname
            - --no-collector.vmstat
            - --no-collector.xfs
            - --no-collector.zfs
            - --log.level=debug
          ports:
            - containerPort: 9100
              protocol: TCP
          volumeMounts:
            - name: var-log-wrapper
              mountPath: /var/log/wrapper
      volumes:
        - name: var-log-wrapper
          emptyDir: {}

---
apiVersion: apps/v1
kind: StatefulSet

metadata:
  name: redis
  labels:
    app: redis

spec:
  serviceName: redis
  selector:
    matchLabels:
      app: redis
  podManagementPolicy: Parallel
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
        - name: redis
          image: redis
          command:
            - sh
            - -c
            - "taskset -c $redis_cpus redis-server --save '' --loglevel notice --databases 1 $redis_extra"
          env:
            - name: podname
              valueFrom: {fieldRef: {fieldPath: metadata.name}}
            - name: redis_cpus
              valueFrom: {configMapKeyRef: { name: redis-config, key: redis_cpus }}
            - name: redis_extra
              valueFrom: {configMapKeyRef: { name: redis-config, key: redis_extra }}
