import os

include('../common.aurora')

#----------------------------------------------------------------------------------------------------
###
# Params which can be modified by exporting environment variables.
###

# Port that Cassnadra will bind to.
cassandra_port = os.environ.get('cassandra_port', '9042')

# Number of QpS send to cassandra (default: 1000;
# if `ycsb_amplitude` and `ycsb_period` are set - maximum of a sine curve).
ycsb_target = os.environ.get('ycsb_target', '1000')

# Number of YCSB threads.
ycsb_thread_count = os.environ.get('ycsb_thread_count', '1')

# ycsb_period and ycsb_amplitude are used to generate non-constant number of QpS;
# see: http://jwilson.coe.uga.edu/EMAT6680/Dunbar/Assignment1/sine_curves_KD.html.
ycsb_period = os.environ.get('ycsb_period', '100')
ycsb_amplitude = os.environ.get('ycsb_amplitude', '100')
# Defaults to: https://docs.oracle.com/javase/7/docs/api/java/lang/Integer.html#MAX_VALUE
ycsb_operation_count = os.environ.get('ycsb_operation_count', '2147483647')


# Currently only cassandra is supported.
application = os.environ.get('application', 'cassandra')

# Workarounds for "force pull images" defect in Aurora.
ycsb_image_tag = os.environ.get('ycsb_image_tag')

# Docker image for cassandra.
# By default we use cassandra docker image from dockerhub https://hub.docker.com/_/cassandra/.
cassandra_image_tag = os.environ.get('cassandra_image_tag', '3.11.3')
cassandra_image = os.environ.get('cassandra_image', 'cassandra')

slo = os.environ.get('ycsb_cassandra_slo')
#----------------------------------------------------------------------------------------------------


# Add label for identification workload in prometheus.
wrapper_labels["name"] = '%s--%s' % (application, workload_uniq_id)
wrapper_labels['load_generator'] = 'ycsb'
wrapper_labels['application'] = application


# JOB definitions
jobs = [
  Service(
    name='cassandra--%s' % workload_uniq_id,
    cluster=cluster,
    environment='staging'+env_uniq_id,
    role=role,
    enable_hooks=True,
    container=Mesos(
      image=DockerImage(
        name=cassandra_image,
        tag=cassandra_image_tag,
      ),
    ),
    constraints=dict(own_ip=application_host_ip),
    task=SequentialTask(
      name='cassandra--%s' % workload_uniq_id,
      resources=Resources(cpu=8, ram=2*GB, disk=2*GB),
      processes=[
        Process(
          name='prep_configs',
          cmdline="""
            set -x \
            && sed -i 's/native_transport_port: 9042/native_transport_port: {cassandra_port}/' /etc/cassandra/cassandra.yaml \
            && sed -i 's/storage_port: 7000/storage_port: {{{{thermos.ports[storage_port]}}}}/' /etc/cassandra/cassandra.yaml \
            && sed -i 's/JMX_PORT=\"7199\"/JMX_PORT=\"{{{{thermos.ports[jmx_port]}}}}\"/' /etc/cassandra/cassandra-env.sh \
            && cat /etc/cassandra/cassandra.yaml
            """.format(cassandra_port=cassandra_port)
        ),
        Process(
          name='cassandra',
          cmdline='env CASSANDRA_CONFIG=/etc/cassandra /docker-entrypoint.sh'
        ),
      ],
    ),
  ),
  Service(
    name='ycsb--%s' % workload_uniq_id,
    cluster=cluster,
    environment='staging'+env_uniq_id,
    role=role,
    constraints=dict(own_ip=load_generator_host_ip),
    container=Mesos(image=DockerImage(
      name=docker_registry+'/serenity/ycsb', tag=ycsb_image_tag,
    )),
    task=SequentialTask(
      name='ycsb--%s' % workload_uniq_id,
      resources=Resources(cpu=1.5, ram=2*GB, disk=5*GB),
      processes=[
        # Wait until cassandra initialize itself.
        Process(
          name='ycsb_cassandra_wait_for_cassandra',
          cmdline="""
          set -x
          until nc -vz {cassandra_address} {cassandra_port}; do
            echo "$(date) Waiting for cassandra to initialize itself."
            sleep 3
          done
          """.format(cassandra_address=application_host_ip, cassandra_port=cassandra_port),
        ),
        Process(
          name='ycsb_cassandra_create_structure',
          cmdline="""
            set -x
            cqlsh --cqlversion 3.4.4 -e \
                "create keyspace ycsb WITH REPLICATION = {{'class' : 'SimpleStrategy', 'replication_factor': 1 }};" \
                {cassandra_address} {cassandra_port} || true
            cqlsh --cqlversion 3.4.4 -k ycsb -e \
                "create table usertable (y_id varchar primary key, field0 varchar,
                field1 varchar, field2 varchar, field3 varchar, field4 varchar,
                field5 varchar, field6 varchar, field7 varchar, field8 varchar,
                field9 varchar);" \
                {cassandra_address} {cassandra_port} || true
          """.format(cassandra_address=application_host_ip, cassandra_port=cassandra_port),
        ),
        Process(
          name='ycsb_cassandra_load',
          cmdline="""
            set -x
            cd /opt/ycsb
            ./bin/ycsb load cassandra2-cql -s \
                -P workloads/workloada \
                -p hosts={cassandra_host} \
                -p port={cassandra_port} \
                -p status.interval=1 \
                -p threadcount=20
          """.format(cassandra_host=application_host_ip, cassandra_port=cassandra_port),
        ),
        Process(
          name='ycsb_cassandra_run',
          cmdline="""
            set -x
            cd /opt/ycsb
            ycsb_wrapper.pex \
                --command \
                    "/opt/ycsb/bin/ycsb run cassandra2-cql -s \
                        -P workloads/workloada \
                        -p hosts={application_host_ip} \
                        -p port={cassandra_port} \
                        -target {ycsb_target} \
                        -p status.interval=1 \
                        -p threadcount={ycsb_thread_count} \
                        -p workload.peroid={ycsb_period} \
                        -p workload.amplitude={ycsb_amplitude} \
                        -p workload.phase=0 \
                        -p operationcount={ycsb_operation_count}" \
                --metric_name_prefix 'cassandra_' \
                --stderr 1 --kafka_brokers "{kafka_brokers}" \
                --kafka_topic {kafka_topic} \
                --log_level {log_level} \
                --labels "{labels}" \
                --peak_load {peak_load} --load_metric_name "cassandra_ops_per_sec" \
                --slo {slo} --sli_metric_name "cassandra_read_p9999"
          """.format(
            application_host_ip=application_host_ip,
            cassandra_port=cassandra_port,
            ycsb_target=ycsb_target,
            ycsb_thread_count=ycsb_thread_count,
            ycsb_period=ycsb_period,
            ycsb_amplitude=ycsb_amplitude,
            ycsb_operation_count=ycsb_operation_count,
            kafka_brokers=wrapper_kafka_brokers,
            kafka_topic='owca_apms_cassandra',
            log_level=wrapper_log_level,
            labels=str(wrapper_labels),
            peak_load=str(int(ycsb_target)+int(ycsb_amplitude)),
            slo=slo)
          )
      ],
    ),
  )
]

hooks = [AddMetadata(wrapper_labels)]
